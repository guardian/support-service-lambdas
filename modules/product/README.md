# Product Module
### If you are looking for how to regenerate catalog types, jump to the [implementation section](#implementation)

---------------------------------
## Introduction
This module defines a simplified product catalog model and mappings between that structure and the larger, more general catalog structure which we export from Zuora.

There are two main types involved in our product definitions and they map onto the identically named objects in the [Zuora product catalog](https://knowledgecenter.zuora.com/Zuora_Billing/Build_products_and_prices/Basic_concepts_and_terms/AAA_Product_Catalog_Concepts)
## `Product`
This represents a particular product defined in the Zuora catalog. 
Available values are:

- NationalDelivery
- HomeDelivery
- SubscriptionCard

which are all types of Newspaper subscription

- GuardianWeeklyDomestic
- GuardianWeeklyRestOfWorld

which are both types of Guardian Weekly

- DigitalSubscription
- SupporterPlus
- Contribution

## `ProductRatePlan`
This maps to a Zuora product rate plan. Each ProductRatePlanKey belongs to a specific zuora product so it is a generic type with the signature:
```typescript
type ProductRatePlanKey<P extends ProductKey>
```
Product rate plans for each product are:

- HomeDelivery & SubscriptionCard
  - Saturday
  - Sunday
  - Weekend
  - Sixday
  - Everyday
  

- NationalDelivery
  - Weekend
  - Sixday
  - Everyday // National delivery doesn't have a Saturday and Sunday option


- GuardianWeeklyDomestic & GuardianWeeklyRestOfWorld
  - Monthly
  - Annual
  - Quarterly
  - SixWeekly
  - OneYearGift
  - ThreeMonthGift


- DigitalSubscription
  - Monthly
  - Annual
  - OneYearGift
  - ThreeMonthGift

 
- SupporterPlus
  - Monthly
  - Annual

This diagram shows all product keys and their associated product rate plan keys:

![product-catalog.png](product-catalog.png)
# Usage
The product catalog object contains pricing information and Zuora ids for product rate plans and product rate plan charges (needed when creating subscriptions). For instance if I want to find the GBP price to get the Newspaper delivered on a Saturday I can use the following:
```typescript
import { getZuoraCatalog } from '@modules/catalog/catalog';
import { getProductRatePlan } from '@modules/product/productCatalogMapping';

const catalog: ProductCatalog = await getProductCatalogFromApi('CODE');

const price = catalog.products.HomeDelivery.ratePlans.Saturday.pricing.GBP;
// price is 19.99

```
The way that the key types `ProductFamilyKey`, `ZuoraProductKey` and `ProductRatePlanKey` are defined in a dependent hierarchy ensures that we can only use options which are appropriate for the given product

```typescript
import {getProductRatePlanId} from "./productToCatalogMapping";

const productRatePlan = getProductRatePlan(
    'CODE',
    'GuardianWeekly',
    'HomeDelivery', // TS2345: Argument of type "Digital" is not assignable to parameter of type "RestOfWorld" | "Domestic"
    'Monthly',
);
```
The product rate plan object also holds information about the charges that plan contains, and that charge info is also strongly typed to the particular product variant.
```typescript
import {getProductRatePlanId} from "./productToCatalogMapping";

const mondayRatePlanChargeId = getProductRatePlan(
      'CODE', 
      'Newspaper', 
      'NationalDelivery', 
      'Everyday'
).charges.Monday

// If we try to access a charge which doesn't exist we will get a compile error 
const sundayRatePlanChargeId = getProductRatePlan(
        'CODE',
        'Newpaper',
        'NationalDelivery',
        'Sixday'
).charges.Sunday // TS2339: Property Sunday does not exist on type


```
## Implementation
The mapping between our object model and Zuora's catalog is defined in two json files `codeCatalogMapping.json` and `prodCatalogMapping.json`.  These are actually generated from the zuora catalog itself using the functions in `generateProductCatalog.ts`. 

Whenever the catalog changes these json files can be regenerated by running the command
```shell
pnpm --filter product generateMapping
```
from the root of the repository.