AWSTemplateFormatVersion: "2010-09-09"
Description: Remove Billing Accounts and related records from SF

Parameters:
  Stage:
    Description: Stage name
    Type: String

Mappings:
  StageMap:
    DEV:
      SalesforceUrl: https://gnmtouchpoint--dev.my.salesforce.com
      SalesforceSecretsVersion: 89ac830e-166c-444a-a61b-72fb5173e761
      ZuoraUrl: https://rest.apisandbox.zuora.com
      ZuoraAccount: SfSaves
      ZuoraSecretsVersion: 4460c713-12dc-4fef-87c1-bf416ff73d5c
    CODE:
      SalesforceUrl: https://gnmtouchpoint--uat.my.salesforce.com
      SalesforceSecretsVersion: 5a68b23e-6d75-4bb4-9131-a4d94c121010
      ZuoraUrl: https://rest.apisandbox.zuora.com
      ZuoraAccount: SubscriptionsZuoraApi
      ZuoraSecretsVersion: 92a2b806-1f9b-4e6f-8d7f-8b774e6a5196
    PROD:
      SalesforceUrl: https://gnmtouchpoint.my.salesforce.com
      SalesforceSecretsVersion: cfe10466-bd62-45f2-a61f-3fcf9c12ef9f
      ZuoraUrl: https://rest.zuora.com
      ZuoraAccount: SupportServiceLambdas
      ZuoraSecretsVersion: abea25fb-bc38-4ef9-89a8-6efabc9750b9

Resources:
  SFBillingAccountRemoverRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - sts:AssumeRole
      Path: /
      Policies:
        - PolicyName: SFBillingAccountRemoverPolicy
          PolicyDocument:
            Statement:
              - Effect: Allow
                Action:
                  - lambda:InvokeFunction
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Sub arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/sf-billing-account-remover-${Stage}:log-stream:*

  SFBillingAccountRemoverLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName:
        !Sub sf-billing-account-remover-${Stage}
      Description: Remove Billing Accounts and related records from Salesforce (via Zuora)
      Code:
        S3Bucket: support-service-lambdas-dist
        S3Key: !Sub membership/${Stage}/sf-billing-account-remover/sf-billing-account-remover.jar
      Handler: com.gu.sf_billing_account_remover.BillingAccountRemover::lambda
      Environment:
        Variables:
          Stage: !Ref Stage
          apiAccessKeyId:
            !Sub
            - '{{resolve:secretsmanager:${Stage}/Zuora/${Account}:SecretString:apiAccessKeyId::${SecretsVersion}}}'
            - Account: !FindInMap [StageMap, !Ref Stage, ZuoraAccount]
              SecretsVersion: !FindInMap [StageMap, !Ref Stage, ZuoraSecretsVersion]
          apiSecretAccessKey:
            !Sub
            - '{{resolve:secretsmanager:${Stage}/Zuora/${Account}:SecretString:apiSecretAccessKey::${SecretsVersion}}}'
            - Account: !FindInMap [StageMap, !Ref Stage, ZuoraAccount]
              SecretsVersion: !FindInMap [StageMap, !Ref Stage, ZuoraSecretsVersion]
          authUrl: !FindInMap [StageMap, !Ref Stage, SalesforceUrl]
          clientId:
            !Sub
            - '{{resolve:secretsmanager:${Stage}/Salesforce/MembersDataApi:SecretString:clientId::${SecretsVersion}}}'
            - SecretsVersion: !FindInMap [StageMap, !Ref Stage, SalesforceSecretsVersion]
          clientSecret:
            !Sub
            - '{{resolve:secretsmanager:${Stage}/Salesforce/MembersDataApi:SecretString:clientSecret::${SecretsVersion}}}'
            - SecretsVersion: !FindInMap [StageMap, !Ref Stage, SalesforceSecretsVersion]
          password:
            !Sub
            - '{{resolve:secretsmanager:${Stage}/Salesforce/MembersDataApi:SecretString:password::${SecretsVersion}}}'
            - SecretsVersion: !FindInMap [StageMap, !Ref Stage, SalesforceSecretsVersion]
          token:
            !Sub
            - '{{resolve:secretsmanager:${Stage}/Salesforce/MembersDataApi:SecretString:token::${SecretsVersion}}}'
            - SecretsVersion: !FindInMap [StageMap, !Ref Stage, SalesforceSecretsVersion]
          username:
            !Sub
            - '{{resolve:secretsmanager:${Stage}/Salesforce/MembersDataApi:SecretString:userName::${SecretsVersion}}}'
            - SecretsVersion: !FindInMap [StageMap, !Ref Stage, SalesforceSecretsVersion]
          zuoraInstanceUrl: !FindInMap [StageMap, !Ref Stage, ZuoraUrl]

      Role:
        !GetAtt SFBillingAccountRemoverRole.Arn
      MemorySize: 512
      Runtime: java8
      Timeout: 900
    DependsOn:
      - SFBillingAccountRemoverRole
