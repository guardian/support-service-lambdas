# Buildgen - build file generator

Buildgen produces standardised build files for all lambda modules and their associated cdk modules.
This prevents inconsistency between lambdas especially for dependency versions.

## Quick reference
- To add a dependency, edit [src/data/build.ts](src/data/build.ts) then `pnpm snapshot:update`
- To bump a version, edit [src/data/dependencies.ts](src/data/dependencies.ts) then `pnpm snapshot:update`
- To fix a failing buildgen check, run `pnpm snapshot:update` to refresh the full set of build files
- Templates are stored in [src/data/handlerTemplate](src/data/handlerTemplate) then `pnpm snapshot:update`

### Migrating an existing handler to use buildgen
This requires the project to be restructured, and the definition added to buildgen and then tested and refined.

1. run the migration script `pnpm run migrate-handler <handler-name>`
1. Add your new handler to [src/data/build.ts](src/data/build.ts)
1. Run `pnpm snapshot:assert` and `pnpm snapshot:assert <handler-name>` to see any differences
1. Edit the buildgen data (and existing files) to resolve any differences
1. retest until you are happy
1. Run `pnpm snapshot:update` to generate and overwrite the full set of build files
1. Check and update handlers/<handler-name>/cdk/bin/cdk.ts accordingly
1. Push and test your changes in CODE.

## Background
As standard, we have to have a lot of similar package.json files across our handlers,
as well as other config.  There's no easy way to share config as the files generally have
to be physically present in the folder.  In some cases it's not even possible to have imports,
so the whole file content is similar, save for a few accidental or intentional variations.

Buildgen programmatically creates configuration files and per handler config from TS templates.
To put it another way, buildgen to build definitions is what CDK is to cloudformation.

Since tooling expects the files to be located with the code, we commit snapshots of the
config where you would expect it to be normally.  If you need to change a file, update the
buildgen files and regenerate the snapshots before you push.

## Benefits
- allows consistent separate CDK for each project, which makes our builds more scalable.
- prevents unintentional variations in per project configuration
- DRY means it's easier to keep things consistent

## How it runs

The snapshot checking task runs automatically in GHA.  It makes sure that the snapshots match
what is generated by the buildgen code.
